<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>בית</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body{
      background: linear-gradient(135deg,#e0f7fa,#e8f5e9,#fffde7,#fce4ec);
      min-height: 100vh;
    }
    .soft-card{
      background:#fff;
      border:0;
      border-radius:22px;
      box-shadow:0 18px 40px rgba(0,0,0,.08);
    }
    .soft-pill{ border-radius:999px; }
    .soft-btn{
      border-radius:14px;
      padding:10px 14px;
    }
    .title{
      color:#355f6b;
      font-weight:700;
    }
    .muted{ color:#6d5a7a; }
    .badge-soft{
      background:#e3f2fd;
      color:#245b74;
      border-radius:999px;
      padding:.35rem .6rem;
      font-weight:600;
    }
    .badge-soft2{
      background:#fce4ec;
      color:#6d2c4a;
      border-radius:999px;
      padding:.35rem .6rem;
      font-weight:600;
    }
    button.keep-style-disabled:disabled {
    opacity:1 ;
    cursor: not-allowed;
    pointer-events: none;
  }
  </style>
</head>

<body>

{% for message in messages %}
  <div class="alert alert-{{ message.tags }}">
    {{ message }}
  </div>
{% endfor %}

<div class="container py-4">

  <!-- כותרת + התנתקות -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h3 class="title mb-0">משימות הצוות</h3>
        <h4> שלום ל{{request.user.username}}, </h4>

    </div>

    <form method="post" action="{% url 'logout' %}">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-dark soft-btn soft-pill">
        התנתקות
      </button>
    </form>
  </div>

  <div class="row g-3">

    <!-- צד שמאל: משימות + פילטרים -->
    <div class="col-12 {% if is_manager %}col-lg-8{% else %}col-lg-12{% endif %}">

      <!-- פילטרים -->
      <div class="card soft-card mb-3">
        <div class="card-body p-4">
          <h5 class="mb-3 title">סינון</h5>

          <form method="get" class="row g-3 align-items-end">
            <div class="col-12 col-md-5">
              <label class="form-label">סטטוס</label>
              <select name="status" class="form-select soft-pill">
                <option value="">כל הסטטוסים</option>
                {% for s in Status %}
                  <option value="{{ s.value }}" {% if status_param == s.value %}selected{% endif %}>
                    {{ s.label }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12 col-md-5">
              <label class="form-label">עובד</label>
              <select name="worker_id" class="form-select soft-pill">
                <option value="">כל העובדים</option>
                {% for w in workers %}
                  <option value="{{ w.id }}" {% if worker_id == w.id %}selected{% endif %}>
                    {{ w.username }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-12 col-md-2 d-grid gap-2">
              <button type="submit" class="btn soft-btn"
                      style="background:linear-gradient(90deg,#90caf9,#a5d6a7); border:0; color:#083344;">
                סנן
              </button>

              <!-- נקה = קישור תקין -->
              <a href="{% url 'home' %}" class="btn btn-outline-secondary soft-btn">
                נקה
              </a>
            </div>
          </form>
        </div>
      </div>

      <!-- משימות -->
      <div class="row g-3">
        {% for t in tasks %}
          <div class="col-12">
            <div class="card soft-card">
              <div class="card-body p-4">

                <div class="d-flex justify-content-between align-items-start gap-3">
                  <div>
                    <h5 class="mb-1">{{ t.name }}</h5>
                    <div class="small text-muted">
                      יעד: {{ t.finishDate }}
                    </div>
                    <div class="small text-muted">
                      {% if t.worker is not None %}
                        אחראי: {{ t.worker.username }}
                      {% else %}
                        עדיין אין אחראי על המשימה
                      {% endif %}
                    </div>
                  </div>

                  <div class="text-end">
                    <div class="mb-2">
                      <span class="badge-soft">{{ t.get_status_display }}</span>
                      {% if t.worker %}
                        <span class="badge-soft2">משויכת</span>
                      {% else %}
                        <span class="badge-soft2">פנויה</span>
                      {% endif %}
                    </div>
                  </div>
                </div>

                {% if t.description %}
                  <p class="mt-3 mb-0">{{ t.description }}</p>
                {% endif %}

                <hr class="my-3">

                <div class="d-flex flex-wrap gap-2">

                  <!-- שייך לעצמי -->
                  <form method="post" action="{% url 'assignment_task' t.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-primary soft-btn"
                            {% if t.worker is not None %}disabled{% endif %}>
                      שייך לעצמי
                    </button>
                  </form>

                  <!-- הושלמה -->
                  <form method="post" action="{% url 'update_task_status' t.id %}">
                  {% csrf_token %}
                  <button type="submit"
                          class="btn soft-btn keep-style-disabled"
                          style="background:linear-gradient(90deg,#c8e6c9,#fff9c4,#f8bbd0);
                                 border:0; color:#083344;"
                          {% if t.worker != request.user or t.status == 'completed' %}disabled{% endif %}>
                      {%if t.worker is None%}
                      סיימתי
                      {%else%}
                    סיימת את המשימה!
                      {%endif%}
                  </button>
                </form>

                  {% if is_manager %}
                    <!-- מחיקה -->
                    <form method="post" action="{% url 'delete_task' t.id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger soft-btn"
                      {% if t.worker is not None %}disabled{% endif %}>
                        מחק
                      </button>
                    </form>

                    <!-- עדכון -->
                   <form method="get" action="{% url 'update_task' t.id %}">
                      <button type="submit" class="btn btn-outline-secondary soft-btn"
                              {% if t.worker is not None %}disabled{% endif %}>
                        עדכן
                      </button>
                    </form>
                  {% endif %}
                </div>

                {% if is_manager %}
                  {% if edit_task and edit_task.id == t.id %}
                    <div class="mt-4 p-3" style="background:#f7fbff; border-radius:18px;">
                      <h6 class="title mb-3">עריכת משימה</h6>
                      <form method="post" action="{% url 'update_task' t.id %}">
                        {% csrf_token %}
                        {{ edit_form.as_p }}
                        <button type="submit" class="btn soft-btn"
                                style="background:linear-gradient(90deg,#90caf9,#f48fb1); border:0; color:#083344;">
                          שמור
                        </button>
                        <a href="{% url 'home' %}" class="btn btn-outline-secondary soft-btn">ביטול</a>
                      </form>
                    </div>
                  {% endif %}
                {% endif %}

              </div>
            </div>
          </div>

        {% empty %}
          <div class="col-12">
            <div class="card soft-card">
              <div class="card-body text-center p-5">
                <h5 class="title mb-1">אין משימות</h5>
                <div class="muted">כרגע לא קיימות משימות להצגה.</div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

    </div>


    <!-- צד ימין: הוספת משימה (רק מנהל) -->
{% if is_manager %}
      <div class="col-12 col-lg-4">
        <div class="card soft-card">
          <div class="card-body p-4">
            <h5 class="title mb-1">הוספת משימה</h5>
            <div class="muted mb-3">מלאי פרטים והוסיפי משימה לצוות</div>

            <form method="post" action="{% url 'create_task' %}">
              {% csrf_token %}
              {{ add_form.as_p }}

              <button type="submit" class="btn w-100 soft-btn mt-2"
                      style="background:linear-gradient(90deg,#90caf9,#a5d6a7,#f8bbd0); border:0; color:#083344;">
                הוסף משימה
              </button>
            </form>
          </div>
        </div>
      </div>
    {% endif %}


  </div>
</div>

</body>
</html>


